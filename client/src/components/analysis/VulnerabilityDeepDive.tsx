import type { DeepDiveResult } from "@reconspec/shared";
import { useState } from "react";

interface VulnerabilityDeepDiveProps {
  deepDive: DeepDiveResult;
}

export function VulnerabilityDeepDive({
  deepDive,
}: VulnerabilityDeepDiveProps): JSX.Element {
  const [copied, setCopied] = useState(false);

  const handleCopy = (body: string) => {
    navigator.clipboard.writeText(body);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  // Convert &lt; and &gt; back to < and > for display in code blocks
  const decodeHtml = (text: string) => {
    return text.replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&amp;/g, "&");
  };

  return (
    <div className="vulnerability-deep-dive">
      <div className="deep-dive-card">
        {/* Overview */}
        <div className="deep-dive-section">
          <div className="deep-dive-heading">Overview</div>
          <p className="deep-dive-text">{deepDive.overview}</p>
        </div>

        {/* Suggested Testing Tools */}
        {deepDive.tools && deepDive.tools.length > 0 && (
          <div className="deep-dive-section">
            <div className="deep-dive-heading">Suggested Testing Tools</div>
            <div className="tools-list">
              {deepDive.tools.map((tool, index) => (
                <span key={index} className="tool-badge">{tool}</span>
              ))}
            </div>
          </div>
        )}

        {/* Test Scenarios */}
        {deepDive.testScenarios && deepDive.testScenarios.length > 0 && (
          <div className="deep-dive-section">
            <div className="deep-dive-heading">Test Scenarios</div>
            {deepDive.testScenarios.map((scenario, index) => (
              <div key={index} className="scenario-card">
                <h4 className="scenario-title">Scenario {index + 1}</h4>

                <div className="scenario-section">
                  <div className="scenario-label">Context</div>
                  <p className="scenario-content">{scenario.context}</p>
                </div>

                <div className="scenario-section">
                  <div className="scenario-label">Legitimate Request</div>
                  <pre className="scenario-code"><code>{decodeHtml(scenario.legitimateRequest)}</code></pre>
                </div>

                <div className="scenario-section">
                  <div className="scenario-label">Malicious Payload</div>
                  <pre className="scenario-code malicious-payload"><code>{decodeHtml(scenario.maliciousPayload)}</code></pre>
                </div>

                <div className="scenario-section">
                  <div className="scenario-label">Explanation</div>
                  <p className="scenario-content">{scenario.explanation}</p>
                </div>
              </div>
            ))}
          </div>
        )}

        {/* Sample Payload (singular, optional) */}
        {deepDive.samplePayload && (
          <div className="deep-dive-section">
            <div className="deep-dive-heading">Sample Payload</div>
            <div>
              <div
                style={{
                  fontSize: "11px",
                  color: "var(--text-tertiary)",
                  marginBottom: "4px",
                }}
              >
                {deepDive.samplePayload.label}
              </div>
              <div className="payload-block">
                <span className="payload-label">{deepDive.samplePayload.contentType}</span>
                <pre
                  style={{
                    margin: 0,
                    fontFamily: "var(--font-mono)",
                    fontSize: "12px",
                    color: "var(--text-primary)",
                    whiteSpace: "pre-wrap",
                    wordBreak: "break-word",
                  }}
                >
                  <code>{decodeHtml(deepDive.samplePayload.body)}</code>
                </pre>
                <button
                  onClick={() => handleCopy(deepDive.samplePayload!.body)}
                  style={{
                    position: "absolute",
                    top: "8px",
                    left: "8px",
                    padding: "4px 6px",
                    background: "var(--bg-tertiary)",
                    border: "1px solid var(--border-default)",
                    borderRadius: "4px",
                    fontSize: "11px",
                    color: "var(--text-secondary)",
                    cursor: "pointer",
                    display: "flex",
                    alignItems: "center",
                    gap: "4px",
                  }}
                  aria-label="Copy payload to clipboard"
                >
                  <svg
                    width="12"
                    height="12"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth="2"
                  >
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                  </svg>
                  {copied ? "Copied!" : "Copy"}
                </button>
              </div>
              <div
                style={{
                  fontSize: "11px",
                  color: "var(--text-tertiary)",
                  marginTop: "4px",
                }}
              >
                {deepDive.samplePayload.description}
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
